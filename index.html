<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ESP32-CAM Viewer</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; background:#000; color:#9aa0a6; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    #wrap { position: fixed; inset: 0; display: grid; place-items: center; background:#000; }
    #img { max-width: 100vw; max-height: 100vh; object-fit: contain; display:block; }
    #status {
      position: fixed; left: 10px; bottom: 10px; background: rgba(0,0,0,.55);
      padding: 6px 10px; border-radius: 8px; font-size: 12px; line-height: 1.2; color:#cfd3d7;
    }
  </style>
</head>
<body>
  <div id="wrap">
    <img id="img" alt="camera stream" />
  </div>
  <div id="status">Connecting…</div>

  <!-- MQTT.js (browser) -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    // ======= ตั้งค่าได้ที่นี่ =======
    const MQTT_HOST   = "wss://test.mosquitto.org:8081";  // ใช้ broker ที่ ESP32-CAM publish อยู่
    const MQTT_TOPIC  = "esp32cam/cam1/image";            // ต้องตรงกับ ESP32-CAM
    const CLIENT_ID   = "viewer-" + Math.random().toString(16).slice(2);
    const OPTIONS = { clientId: CLIENT_ID, keepalive: 30, reconnectPeriod: 2000, clean: true };
    // ===============================

    const imgEl = document.getElementById("img");
    const statusEl = document.getElementById("status");

    function setStatus(text) { statusEl.textContent = text; }

    const client = mqtt.connect(MQTT_HOST, OPTIONS);

    client.on("connect", () => {
      setStatus("Connected • subscribing…");
      client.subscribe(MQTT_TOPIC, { qos: 0 }, (err) => {
        setStatus(err ? "Subscribe error" : "Subscribed: " + MQTT_TOPIC);
      });
    });

    client.on("reconnect", () => setStatus("Reconnecting…"));
    client.on("close",     () => setStatus("Disconnected"));
    client.on("error",     (e) => setStatus("Error: " + (e && e.message ? e.message : e)));

    client.on("message", (_topic, payload) => {
      const dataUrl = payload.toString(); // ESP32-CAM ส่งมาเป็น Base64 + prefix
      if (imgEl.src !== dataUrl) imgEl.src = dataUrl;
      setStatus("Live • " + new Date().toLocaleTimeString());
    });

    // แตะจอเพื่อซ่อน/โชว์สถานะ
    document.body.addEventListener("click", () => {
      statusEl.style.display = (statusEl.style.display === "none") ? "block" : "none";
    });
  </script>
</body>
</html>

